<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aidstack Medical AI | FHIR-Compliant Clinical Documentation</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --aidstack-navy: #1A365D;
            --aidstack-orange: #FF6B35;
            --slate-dark: #0F172A;
            --slate-medium: #475569;
            --slate-light: #94A3B8;
            --slate-bg: #F8FAFC;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .font-display {
            font-family: 'Space Grotesk', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--slate-bg) 0%, #ffffff 100%);
        }
        .card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.08);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
        }

        .mic-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--aidstack-orange);
        }

        .mic-container:hover {
            background: #E55A2B;
            transform: scale(1.05);
        }

        .mic-icon {
            font-size: 36px;
            transition: all 0.3s ease;
            color: white;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(255, 107, 53, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0);
            }
        }
        .fhir-section {
            border-left: 4px solid;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        .fhir-section h3 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--slate-dark);
        }
        .fhir-section ul {
            list-style-type: none;
            padding-left: 0;
        }
        .fhir-section li {
            margin-bottom: 0.25rem;
        }
        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .expanded {
            max-height: 500px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
        <!-- Aidstack Header -->
        <div class="px-8 py-6" style="background: var(--aidstack-navy);">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--aidstack-orange);">
                        <i class="fas fa-brain text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-display font-bold text-2xl text-white">Aidstack Medical AI</h1>
                        <p class="text-sm" style="color: var(--slate-light);">FHIR-compliant clinical documentation</p>
                    </div>
                </div>
                <div class="hidden md:block">
                    <span class="px-4 py-2 rounded-lg text-sm font-display font-medium" style="background: rgba(255, 255, 255, 0.1); color: white;">
                        <i class="fas fa-shield-alt mr-2"></i>HIPAA Ready
                    </span>
                </div>
            </div>
        </div>

        <div class="p-8">
            <!-- Patient Information Section -->
            <div class="mb-8 p-6 rounded-lg card">
                <h3 class="font-display font-semibold text-lg mb-4 flex items-center" style="color: var(--slate-dark);">
                    <i class="fas fa-user-md mr-2" style="color: var(--aidstack-navy);"></i>
                    Patient Information
                </h3>

                <!-- Patient Mode Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Patient Record</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="patientMode" value="new" class="mr-2" checked>
                            <span class="text-sm" style="color: var(--slate-medium);">New Patient</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="patientMode" value="existing" class="mr-2">
                            <span class="text-sm" style="color: var(--slate-medium);">Existing Patient</span>
                        </label>
                    </div>
                </div>

                <!-- Existing Patient Search (hidden by default) -->
                <div id="existingPatientSection" class="mb-4" style="display: none;">
                    <label for="patientSearch" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Search Patient</label>
                    <div class="relative">
                        <input type="text" id="patientSearch" placeholder="Search by name or ID..." class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);">
                        <button id="searchPatientBtn" class="absolute right-2 top-2 px-4 py-2 rounded-lg font-display font-medium" style="background: var(--aidstack-navy); color: white;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="mt-2"></div>
                </div>

                <!-- New Patient Form -->
                <div id="newPatientSection">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="patientGivenName" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Given Name <span style="color: var(--aidstack-orange);">*</span></label>
                            <input type="text" id="patientGivenName" placeholder="John" class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);" required>
                        </div>
                        <div>
                            <label for="patientFamilyName" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Family Name <span style="color: var(--aidstack-orange);">*</span></label>
                            <input type="text" id="patientFamilyName" placeholder="Doe" class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);" required>
                        </div>
                        <div>
                            <label for="patientGender" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Gender <span style="color: var(--aidstack-orange);">*</span></label>
                            <select id="patientGender" class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);" required>
                                <option value="">Select...</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                        <div>
                            <label for="patientBirthdate" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Birth Date <span style="color: var(--aidstack-orange);">*</span></label>
                            <input type="date" id="patientBirthdate" class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);" required>
                        </div>
                        <div>
                            <label for="patientIdentifierType" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">ID Type <span style="color: var(--aidstack-orange);">*</span></label>
                            <select id="patientIdentifierType" class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);" required>
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div>
                            <label for="patientIdentifier" class="block text-sm font-display font-medium mb-2" style="color: var(--slate-dark);">Patient ID Number <span style="color: var(--aidstack-orange);">*</span></label>
                            <input type="text" id="patientIdentifier" placeholder="MRN-12345" class="block w-full px-4 py-3 border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);" required>
                        </div>
                    </div>
                </div>

                <p class="mt-3 text-xs" style="color: var(--slate-medium);">
                    <i class="fas fa-info-circle mr-1"></i>Fields marked with <span style="color: var(--aidstack-orange);">*</span> are required for OpenMRS
                </p>
            </div>

            <!-- OpenMRS Configuration -->
            <div class="mb-8 p-4 rounded-lg" style="background: rgba(26, 54, 93, 0.05); border: 1px solid var(--slate-light);">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-display font-semibold flex items-center" style="color: var(--slate-dark);">
                        <i class="fas fa-database mr-2" style="color: var(--aidstack-navy);"></i>
                        OpenMRS Server
                    </h3>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enableOpenMRS" class="mr-2" checked>
                        <span class="text-sm font-display font-medium" style="color: var(--slate-dark);">Enable Push</span>
                    </label>
                </div>
                <div id="openMRSConfig" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="openmrsUrl" class="block text-xs font-display font-medium mb-2" style="color: var(--slate-medium);">Server URL</label>
                        <input type="text" id="openmrsUrl" value="https://dev3.openmrs.org/openmrs" class="block w-full px-3 py-2 text-sm border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);">
                    </div>
                    <div>
                        <label for="openmrsUsername" class="block text-xs font-display font-medium mb-2" style="color: var(--slate-medium);">Username</label>
                        <input type="text" id="openmrsUsername" value="admin" class="block w-full px-3 py-2 text-sm border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);">
                    </div>
                    <div>
                        <label for="openmrsPassword" class="block text-xs font-display font-medium mb-2" style="color: var(--slate-medium);">Password</label>
                        <input type="password" id="openmrsPassword" value="Admin123" class="block w-full px-3 py-2 text-sm border rounded-lg" style="border-color: var(--slate-light); color: var(--slate-dark);">
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-center mb-8">
                <div id="micButton" class="mic-container">
                    <i id="micIcon" class="fas fa-microphone mic-icon"></i>
                </div>
                <p id="status" class="mt-4 text-center text-base font-display font-medium" style="color: var(--slate-dark);"></p>
                <p id="instructions" class="mt-2 text-center text-sm" style="color: var(--slate-medium);"></p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h2 class="text-lg font-display font-semibold mb-4 flex items-center" style="color: var(--slate-dark);">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3" style="background: rgba(26, 54, 93, 0.1);">
                            <i class="fas fa-microphone-alt" style="color: var(--aidstack-navy);"></i>
                        </div>
                        Voice Transcription
                    </h2>
                    <div id="transcription" class="p-4 rounded-lg h-64 overflow-auto text-sm" style="background: var(--slate-bg); color: var(--slate-dark); border: 1px solid #E2E8F0;"></div>
                </div>
                <div class="card p-6">
                    <h2 class="text-lg font-display font-semibold mb-4 flex items-center" style="color: var(--slate-dark);">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3" style="background: rgba(255, 107, 53, 0.1);">
                            <i class="fas fa-file-medical" style="color: var(--aidstack-orange);"></i>
                        </div>
                        FHIR Structured Data
                    </h2>
                    <div id="processedData" class="p-4 rounded-lg h-64 overflow-auto text-sm" style="background: var(--slate-bg); color: var(--slate-dark); border: 1px solid #E2E8F0;">
                        <div id="patientInfo" class="fhir-section" style="border-color: var(--aidstack-navy);">
                            <h3><i class="fas fa-user-circle mr-2"></i>Patient Information</h3>
                            <div id="patientDetails"></div>
                        </div>
                        <div id="conditions" class="fhir-section" style="border-color: #DC2626;">
                            <h3><i class="fas fa-heartbeat mr-2"></i>Conditions</h3>
                            <ul id="conditionsList"></ul>
                        </div>
                        <div id="medications" class="fhir-section" style="border-color: #059669;">
                            <h3><i class="fas fa-pills mr-2"></i>Medications</h3>
                            <ul id="medicationsList"></ul>
                        </div>
                        <div id="procedures" class="fhir-section" style="border-color: var(--aidstack-orange);">
                            <h3><i class="fas fa-procedures mr-2"></i>Procedures</h3>
                            <ul id="proceduresList"></ul>
                        </div>
                        <div id="recommendations" class="fhir-section" style="border-color: #7C3AED;">
                            <h3><i class="fas fa-clipboard-list mr-2"></i>Recommendations</h3>
                            <ul id="recommendationsList"></ul>
                        </div>
                        <div id="explanationText" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-display font-semibold flex items-center" style="color: var(--slate-dark);">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3" style="background: rgba(124, 58, 237, 0.1);">
                                <i class="fas fa-code" style="color: #7C3AED;"></i>
                            </div>
                            Raw AI Response
                        </h2>
                        <button id="copyJsonBtn" class="px-4 py-2 rounded-lg font-display font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-2" style="background: var(--aidstack-navy); color: white;" onmouseover="this.style.background='#0F172A'" onmouseout="this.style.background='var(--aidstack-navy)'">
                            <i class="fas fa-copy mr-2"></i>Copy Response
                        </button>
                    </div>
                    <pre id="rawJsonPayload" class="p-4 rounded-lg max-h-96 overflow-auto text-xs font-mono" style="background: var(--slate-bg); color: var(--slate-dark); border: 1px solid #E2E8F0;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const micButton = document.getElementById('micButton');
        const micIcon = document.getElementById('micIcon');
        const status = document.getElementById('status');
        const instructions = document.getElementById('instructions');
        const transcription = document.getElementById('transcription');
        const processedData = document.getElementById('processedData');
        const rawJsonPayload = document.getElementById('rawJsonPayload');
        const copyJsonBtn = document.getElementById('copyJsonBtn');
        const explanationText = document.getElementById('explanationText');

        // Patient form elements
        const patientModeRadios = document.querySelectorAll('input[name="patientMode"]');
        const newPatientSection = document.getElementById('newPatientSection');
        const existingPatientSection = document.getElementById('existingPatientSection');
        const patientSearch = document.getElementById('patientSearch');
        const searchPatientBtn = document.getElementById('searchPatientBtn');
        const searchResults = document.getElementById('searchResults');

        // OpenMRS elements
        const enableOpenMRS = document.getElementById('enableOpenMRS');
        const openMRSConfig = document.getElementById('openMRSConfig');
        const openmrsUrl = document.getElementById('openmrsUrl');
        const openmrsUsername = document.getElementById('openmrsUsername');
        const openmrsPassword = document.getElementById('openmrsPassword');

        let recognition;
        let isRecording = false;
        let fullTranscription = '';
        let lastFHIRData = null;
        let selectedPatient = null;

        // Patient Mode Toggle
        patientModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'new') {
                    newPatientSection.style.display = 'block';
                    existingPatientSection.style.display = 'none';
                    selectedPatient = null;
                } else {
                    newPatientSection.style.display = 'none';
                    existingPatientSection.style.display = 'block';
                }
            });
        });

        // Load OpenMRS identifier types on page load
        async function loadIdentifierTypes() {
            const username = openmrsUsername.value;
            const password = openmrsPassword.value;

            try {
                const auth = btoa(`${username}:${password}`);
                const response = await fetch('/openmrs-proxy/ws/rest/v1/patientidentifiertype', {
                    headers: {
                        'Authorization': `Basic ${auth}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('patientIdentifierType');
                    select.innerHTML = '<option value="">Select ID Type...</option>';

                    data.results.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.uuid;
                        option.textContent = type.display;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load identifier types');
                    document.getElementById('patientIdentifierType').innerHTML = '<option value="">Error loading types</option>';
                }
            } catch (error) {
                console.error('Error loading identifier types:', error);
                document.getElementById('patientIdentifierType').innerHTML = '<option value="">Error loading types</option>';
            }
        }

        // Search for existing patient
        searchPatientBtn.addEventListener('click', async () => {
            const query = patientSearch.value.trim();
            if (!query) return;

            const username = openmrsUsername.value;
            const password = openmrsPassword.value;

            try {
                const auth = btoa(`${username}:${password}`);
                const response = await fetch(`/openmrs-proxy/ws/rest/v1/patient?q=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': `Basic ${auth}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySearchResults(data.results);
                } else {
                    searchResults.innerHTML = '<p class="text-red-500 text-sm">Search failed</p>';
                }
            } catch (error) {
                console.error('Error searching patients:', error);
                searchResults.innerHTML = '<p class="text-red-500 text-sm">Error: ' + error.message + '</p>';
            }
        });

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-sm" style="color: var(--slate-medium);">No patients found</p>';
                return;
            }

            searchResults.innerHTML = '<div class="space-y-2">';
            results.forEach(patient => {
                // OpenMRS response structure: patient.display has the name
                const name = patient.display || patient.person?.display || 'Unknown Patient';
                const identifier = patient.identifiers?.[0]?.identifier || patient.identifiers?.[0]?.display || 'No ID';

                // Log for debugging
                console.log('Patient data:', patient);

                const div = document.createElement('div');
                div.className = 'p-3 border rounded-lg cursor-pointer hover:bg-gray-50';
                div.style.borderColor = 'var(--slate-light)';
                div.innerHTML = `
                    <div class="font-display font-medium" style="color: var(--slate-dark);">${name}</div>
                    <div class="text-xs" style="color: var(--slate-medium);">ID: ${identifier}</div>
                `;
                div.onclick = () => selectPatient(patient);
                searchResults.appendChild(div);
            });
        }

        function selectPatient(patient) {
            selectedPatient = patient;
            const name = patient.display || patient.person?.display || 'Unknown Patient';
            searchResults.innerHTML = `<div class="p-3 border rounded-lg" style="background: rgba(26, 54, 93, 0.05); border-color: var(--aidstack-navy);">
                <i class="fas fa-check-circle mr-2" style="color: var(--aidstack-navy);"></i>
                <span class="font-display font-medium" style="color: var(--slate-dark);">Selected: ${name}</span>
            </div>`;
        }

        // Load identifier types when page loads
        window.addEventListener('load', () => {
            loadIdentifierTypes();
        });

        function updateMicState(recording) {
            if (recording) {
                micButton.classList.add('pulse');
                micIcon.classList.remove('fa-microphone');
                micIcon.classList.add('fa-stop');
            } else {
                micButton.classList.remove('pulse');
                micIcon.classList.remove('fa-stop');
                micIcon.classList.add('fa-microphone');
            }
        }

        function setStatus(message) {
            status.textContent = message;
        }

        function setInstructions(message) {
            instructions.innerHTML = message;
        }

        // Copy JSON payload
        copyJsonBtn.addEventListener('click', () => {
            const jsonContent = rawJsonPayload.textContent;
            navigator.clipboard.writeText(jsonContent).then(() => {
                copyJsonBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyJsonBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Copy Response';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecording = true;
                updateMicState(true);
                setStatus('Listening... Speak now.');
                setInstructions('');
            };

            recognition.onend = () => {
                isRecording = false;
                updateMicState(false);
                setStatus('Stopped listening. Processing transcription...');
                processTranscription(fullTranscription);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                fullTranscription += finalTranscript;
                transcription.innerHTML = fullTranscription + '<span class="text-gray-400">' + interimTranscript + '</span>';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                isRecording = false;
                updateMicState(false);

                let errorMessage = 'Speech recognition error: ' + event.error;
                if (event.error === 'network') {
                    errorMessage = 'Network error. Check your internet connection or microphone permissions.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'Microphone access denied. Please allow microphone access in your browser settings.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'No speech detected. Please try again.';
                }

                setStatus(errorMessage);
                setInstructions('Click the microphone to try again.');
            };

            micButton.onclick = () => {
                if (!isRecording) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            };

        } else {
            setStatus('Web Speech API is not supported in this browser.');
            setInstructions('Please try using Google Chrome or Microsoft Edge for speech recognition functionality.');
            micButton.disabled = true;
            micButton.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function processTranscription(text) {
            if (!text || text.trim() === '') {
                setStatus('No transcription to process.');
                return;
            }

            try {
                setStatus('Processing with AI...');

                // Call OpenAI via client-side for now (will move to Vercel function later)
                const apiKey = document.querySelector('meta[name="openai-key"]')?.content || 'YOUR_API_KEY_HERE';

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [{ role: "user", content: getPrompt(text) }],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI API error: ${response.status}`);
                }

                const data = await response.json();
                const processedContent = data.choices[0].message.content;

                // Log the raw response
                console.log('Raw AI response:', processedContent);

                // Store FHIR data
                lastFHIRData = processedContent;

                // Display the processed data
                displayProcessedData(processedContent);
                rawJsonPayload.textContent = processedContent;
                setStatus('AI processing complete.');

                // Push to OpenMRS if enabled
                if (enableOpenMRS.checked) {
                    await pushToOpenMRS(processedContent);
                }

            } catch (error) {
                console.error('Error processing transcription:', error);
                processedData.innerHTML = `<p style="color: var(--aidstack-orange);">Error: ${error.message}</p>`;
                rawJsonPayload.textContent = 'Error: ' + error.message;
                setStatus('Error processing transcription.');
            }
        }

        async function pushToOpenMRS(fhirData) {
            try {
                setStatus('Pushing to OpenMRS...');

                const username = openmrsUsername.value;
                const password = openmrsPassword.value;
                const auth = btoa(`${username}:${password}`);

                // Get patient mode
                const patientMode = document.querySelector('input[name="patientMode"]:checked').value;

                let patientUuid;

                if (patientMode === 'existing') {
                    // Use existing patient
                    if (!selectedPatient) {
                        setStatus('Please select a patient first.');
                        return;
                    }
                    patientUuid = selectedPatient.uuid;
                } else {
                    // Create new patient
                    const givenName = document.getElementById('patientGivenName').value;
                    const familyName = document.getElementById('patientFamilyName').value;
                    const gender = document.getElementById('patientGender').value;
                    const birthdate = document.getElementById('patientBirthdate').value;
                    const identifierType = document.getElementById('patientIdentifierType').value;
                    const identifier = document.getElementById('patientIdentifier').value;

                    if (!givenName || !familyName || !gender || !birthdate || !identifierType || !identifier) {
                        setStatus('Please fill all required patient fields.');
                        return;
                    }

                    // Create patient
                    const patientPayload = {
                        person: {
                            names: [{
                                givenName: givenName,
                                familyName: familyName
                            }],
                            gender: gender,
                            birthdate: birthdate
                        },
                        identifiers: [{
                            identifier: identifier,
                            identifierType: identifierType,
                            location: "44c3efb0-2583-4c80-a79e-1f756a03c0a1" // Unknown Location
                        }]
                    };

                    const patientResponse = await fetch('/openmrs-proxy/ws/rest/v1/patient', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Basic ${auth}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(patientPayload)
                    });

                    if (!patientResponse.ok) {
                        const errorText = await patientResponse.text();
                        throw new Error(`Failed to create patient: ${errorText}`);
                    }

                    const newPatient = await patientResponse.json();
                    patientUuid = newPatient.uuid;
                    console.log('Created patient:', newPatient);
                }

                // Create encounter
                const encounterPayload = {
                    patient: patientUuid,
                    encounterType: "07000be2-26b6-4cce-8b40-866d8435b613", // Adult Initial
                    encounterDatetime: new Date().toISOString(),
                    location: "44c3efb0-2583-4c80-a79e-1f756a03c0a1" // Unknown Location
                };

                const encounterResponse = await fetch('/openmrs-proxy/ws/rest/v1/encounter', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(encounterPayload)
                });

                if (!encounterResponse.ok) {
                    throw new Error('Failed to create encounter');
                }

                const encounter = await encounterResponse.json();
                console.log('Created encounter:', encounter);

                setStatus('âœ“ Successfully pushed to OpenMRS!');
                setTimeout(() => setStatus('Ready to record.'), 3000);

            } catch (error) {
                console.error('OpenMRS push error:', error);
                setStatus('OpenMRS push failed: ' + error.message);
            }
        }


        function getPrompt(text) {
            return `
                You are an AI assistant specialized in medical transcription and clinical decision support. Your task is to analyze the following medical transcription and provide a structured response based on the transcription, following the FHIR (Fast Healthcare Interoperability Resources) format.

                Medical Transcription:
                ${text}

                Please provide a comprehensive analysis based on the transcription, including potential diagnoses (differential diagnosis and testing to support medical decision making), medications, procedures, and recommendations for further action or treatment. Structure your response as a JSON object with the following FHIR-compliant resources:

                1. Patient
                2. Condition (list of potential diagnoses)
                3. MedicationStatement (list of mentioned medications)
                4. Procedure (list of mentioned or recommended procedures)
                5. CarePlan (list of recommendations or follow-up actions)

                Ensure that each resource follows the FHIR structure and includes relevant details from the transcription.
            `;
        }

        function displayProcessedData(data) {
    const patientDetails = document.getElementById('patientDetails');
    const conditionsList = document.getElementById('conditionsList');
    const medicationsList = document.getElementById('medicationsList');
    const proceduresList = document.getElementById('proceduresList');
    const recommendationsList = document.getElementById('recommendationsList');
    const explanationText = document.getElementById('explanationText');

    // Clear previous content
    patientDetails.innerHTML = '';
    conditionsList.innerHTML = '';
    medicationsList.innerHTML = '';
    proceduresList.innerHTML = '';
    recommendationsList.innerHTML = '';
    explanationText.innerHTML = '';

    // Attempt to extract JSON from the response
    let jsonData = '';
    let explanation = '';
    
    try {
        // Find the first occurrence of a valid JSON object
        const jsonStart = data.indexOf('{');
        const jsonEnd = data.lastIndexOf('}');
        
        if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
            jsonData = data.substring(jsonStart, jsonEnd + 1);
            explanation = data.substring(jsonEnd + 1).trim();
        } else {
            throw new Error('No valid JSON found in the response');
        }

        // Parse the JSON data
        const fhirData = JSON.parse(jsonData);

        // Helper function to safely access nested properties
        const safelyAccessProperty = (obj, path) => {
            return path.split('.').reduce((acc, part) => acc && acc[part], obj);
        };

        // Helper function to create list items
        const createListItem = (resource, displayPath, detailsCallback) => {
            const display = safelyAccessProperty(resource, displayPath) || 'Unknown';
            const li = document.createElement('li');
            li.innerHTML = `
                <strong>${display}</strong>
                ${detailsCallback ? `
                    <button class="ml-2 text-blue-500 hover:text-blue-700" onclick="toggleDetails(this)">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="expandable-content mt-2 ml-4 text-sm text-gray-600">
                        ${detailsCallback(resource)}
                    </div>
                ` : ''}
            `;
            return li;
        };

        // Display Patient Information
        if (fhirData.entry && Array.isArray(fhirData.entry)) {
            const patient = fhirData.entry.find(e => e.resource && e.resource.resourceType === 'Patient')?.resource;
            if (patient && patient.name && patient.name[0]) {
                const givenName = patient.name[0].given ? patient.name[0].given.join(' ') : 'Unknown';
                const familyName = patient.name[0].family || 'Unknown';
                patientDetails.innerHTML = `
                    <p><strong>Name:</strong> ${givenName} ${familyName}</p>
                    <p><strong>ID:</strong> ${patient.id || 'Unknown'}</p>
                `;
            }
        }

        // Display Conditions
        const conditions = fhirData.entry?.filter(e => e.resource && e.resource.resourceType === 'Condition') || [];
        conditions.forEach(entry => {
            const condition = entry.resource;
            const li = createListItem(condition, 'code.coding.0.display', (res) => `
                <p><strong>Code:</strong> ${safelyAccessProperty(res, 'code.coding.0.code') || 'Unknown'}</p>
                <p><strong>System:</strong> ${safelyAccessProperty(res, 'code.coding.0.system') || 'Unknown'}</p>
            `);
            conditionsList.appendChild(li);
        });

        // Display Medications
        const medications = fhirData.entry?.filter(e => e.resource && e.resource.resourceType === 'MedicationStatement') || [];
        medications.forEach(entry => {
            const med = entry.resource;
            const li = createListItem(med, 'medicationCodeableConcept.text');
            medicationsList.appendChild(li);
        });

        // Display Procedures
        const procedures = fhirData.entry?.filter(e => e.resource && e.resource.resourceType === 'Procedure') || [];
        procedures.forEach(entry => {
            const procedure = entry.resource;
            const li = createListItem(procedure, 'code.coding.0.display', (res) => `
                <p><strong>Code:</strong> ${safelyAccessProperty(res, 'code.coding.0.code') || 'Unknown'}</p>
                <p><strong>System:</strong> ${safelyAccessProperty(res, 'code.coding.0.system') || 'Unknown'}</p>
            `);
            proceduresList.appendChild(li);
        });

        // Display Recommendations
        const carePlan = fhirData.entry?.find(e => e.resource && e.resource.resourceType === 'CarePlan')?.resource;
        if (carePlan && carePlan.activity) {
            carePlan.activity.forEach(activity => {
                const li = createListItem(activity, 'detail.code.coding.0.display');
                recommendationsList.appendChild(li);
            });
        }

        // Display explanation
        if (explanation) {
            explanationText.innerHTML = `<h3 class="font-semibold mb-2">AI Explanation:</h3><p>${explanation.replace(/\n/g, '<br>')}</p>`;
        }

    } catch (error) {
        console.error('Error parsing FHIR data:', error);
        processedData.innerHTML = `<p class="text-red-500">Error parsing FHIR data: ${error.message}</p>
            <p class="text-sm mt-2">The AI response may not be in the expected FHIR format or might be truncated. Please check the raw response for details.</p>`;
    }

    // Always display the raw response, even if parsing fails
    rawJsonPayload.textContent = data;
}

        function toggleDetails(button) {
            const content = button.nextElementSibling;
            content.classList.toggle('expanded');
            button.querySelector('i').classList.toggle('fa-chevron-down');
            button.querySelector('i').classList.toggle('fa-chevron-up');
        }
    </script>
</body>
</html>
